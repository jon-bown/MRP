---
title: "NBA Player Net Output Value"
subtitle: 'Comparing Win Share, Win Score, Wins Produced, and RPM Wins to estimate value of player production'
author: "Jonathan Bown"
date: "June 13, 2019"
output: 
  html_document:
    toc: true
abstract: |
  The goal of this analysis is to better understand the similarities and differences between four NBA player metrics: Win Score, Wins Produced, Win Share, and RPM Wins in the context of calculating player output or player value using the economic concept of Marginal Revenue Product. To compare these four metrics I will focus on the Utah Jazz and their trade decisions these last few weeks. My hypothesis is that this method will be able to explain some decision making recently by the Utah Jazz. I want to find which metric, if any, gives a reasonable quanitification of player value. Once a reasonable metric is determined we can test it further by evaluating which players in the league are the most over/under paid by comparing the value of their output to their salary. 
---

<style type="text/css">

body{ /* Normal  */
      font-size: 16px;
  }
td {  /* Table  */
  font-size: 16px;
}
h1.title {
  font-size: 38px;
  color: DarkRed;
}
h1 { /* Header 1 */
  font-size: 28px;
  color: DarkBlue;
}
h2 { /* Header 2 */
    font-size: 22px;
  color: DarkBlue;
}
h3 { /* Header 3 */
  font-size: 18px;
  font-family: "Times New Roman", Times, serif;
  color: DarkBlue;
}
code.r{ /* Code block */
    font-size: 12px;
}
pre { /* Code block - determines code spacing between lines */
    font-size: 14px;
}
caption {
      color: red;
      font-weight: bold;
      font-size: 1.0em;
    } 
</style>


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
library(plyr)
library(dplyr)
library(ggplot2)
#library(lubridate)
library(xts)
library(knitr)
library(xtable)
library(kableExtra)
library(here)
library(stargazer)
library(readxl)
library(scales)
library(here)
```

#Marginal Revenue Product

The quantity 'Marginal Revenue Product' (MRP) is defined as the market value generated by an additional unit of output. A simple example of this is outlined on Investopedia's [web page](https://www.investopedia.com/terms/m/marginal-revenue-product-mrp.asp "Marginal Revenue Product") for the definition of MRP. 

"For example, a farmer wants to know whether to purchase another specialized tractor to seed and harvest wheat. If the extra tractor can eventually produce 3,000 additional bushels of wheat (the MPP), and each additional bushel sells at the market for \$5 (price of the product or marginal revenue), the MRP of the tractor is \$15,000."

In sports economics, one additional unit of output is one additional win. You can measure or estimate what this value would be for a given team by multiplying the value of one additional win by the number of wins a player genarates. More techically MRP can be written as 

$$
MRP_{ij} = MR_{win_j} \times \Delta wins_{ij}
$$

where $MRP_{ij}$ is the marginal revenue product of player $i$ when he plays for team $j$, $MR_{win_j}$ is the value of an additional win to team $j$, and $\Delta wins_{ij}$ is the change added wins for player $i$ on team $j$. The hardest quantity to measure here is the change in wins for a given player. There are several widely used metrics for this that we will explore to find the most reasonable output for evaluating players and their value relative to their cost. 



```{r read}
player_data_raw <- read.csv(here('Player_data.txt'), stringsAsFactors=FALSE, header=TRUE)
team_data <- read.csv(here('Team_data.txt'), stringsAsFactors=FALSE, header=TRUE)
team_key <- read.csv(here('Team_abbrev.txt'), stringsAsFactors=FALSE, header=TRUE)
team_cost_data <- read.csv(here('Team_win_cost.txt'), stringsAsFactors=FALSE, header=TRUE)
player_salary_data <- read.csv(here('Player_sal_data.txt'), stringsAsFactors=FALSE, header=TRUE)
opp_data <- read.csv(here('Opp_data.txt'), stringsAsFactors=FALSE, header=TRUE)
player_ws_data_raw <- read.csv(here('Player_ws_data.txt'), stringsAsFactors=FALSE, header=TRUE)
player_rpmw_data_raw <- read.csv(here('player_rpm_w.csv'), stringsAsFactors=FALSE, header=TRUE)


player_salary_data <- player_salary_data[!duplicated(player_salary_data$Player),]

players_tot <- player_data_raw[which(player_data_raw$Tm == "TOT"),"Player"]
player_data_clean <- player_data_raw[which(!(player_data_raw$Player %in% players_tot)),]
player_data_ws_clean <- player_ws_data_raw[which(!(player_data_raw$Player %in% players_tot)),]
player_rpmw_data_raw$Player  <- lapply(player_rpmw_data_raw$NAME, function(x) {sub("\\,.*","",x)})
for(player in players_tot){
  raw_data1 <- player_data_raw[which(player_data_raw$Player == player), ]
  raw_data2 <- player_ws_data_raw[which(player_ws_data_raw$Player == player), ]
  player_data_clean <- rbind(player_data_clean, raw_data1[3,])
  player_data_ws_clean <- rbind(player_data_ws_clean, raw_data2[3,])
}
```

#Value of a win

As of the end of regular season in 2018 the value of a win for each team is shown below. These numbers are found easily by taking the total dollars a team spends in a season and dividing it by the number of games. 
```{r}
#Calculate win score


cols <- c("Team", "CPW")
df <-  team_cost_data[order(-team_cost_data$CPW),cols] 
df$CPW <- dollar(df$CPW)

kable(x=df, align=c('l','c'), row.names = FALSE, col.names = c('Player', 'Win Value'), caption="Win Value")  %>%
      kable_styling(latex_options = c("striped","hold_position"),
                    full_width = FALSE,font_size = 12)


team_cost_data$CPW <- rep(2949908.82, length(team_cost_data[,1]))

```

For our purposes we are going to assume that each team values a win equally to give an adequate opportunity to compare win contribution metrics. An article from [FiveThirtyEight](https://fivethirtyeight.com/features/forget-giannis-pascal-siakam-is-our-mvp/ "Which NBA Player Literally Gives His Team The Most Value") estimating the surplus value of players claimed this number was $2,949,908.82 per team. Based on the table above we are seeing that this would likely fall close to the average value of a win. 

#Win Share

Win Share was originally developed by Bill James for baseball in 2002. This is a complicated metric takes up about 75 pages of his original book. It was adapted to the NBA not long after it was implemented to baseball. This metric is used to estimate the number of wins a player produces for his team by treating each win as parts of a whole. The number is based on full season statistics of a player. These statistics are available for each player at [basketball-reference.com](https://www.basketball-reference.com "Basketball Reference") and the top 20 are shown below. There tends to be a close one-to-one mapping between the units of Win Share and total wins of a team. This means that if you add up the win shares of all the player on the team, you should get a number very close if not exactly the number of wins a team had during a season.

```{r}
#Calculate win score


cols <- c("Player", "WS")
df <-  player_data_ws_clean[order(-player_data_ws_clean$WS),cols] 
df <- df[1:20,]
df$Player <- lapply(df$Player, function(x) {sub("\\\\.*","",x)})


kable(x=df, align=c('l','c'), row.names = FALSE, col.names = c('Player', 'Win Share'), caption="\\label{wa_corr}Win Share Top 20")  %>%
      kable_styling(latex_options = c("striped","hold_position"),
                    full_width = FALSE,font_size = 12)

```



#Win Score

Win Score was introduced by David Berri in 2006 as another way to compare players on regular season statistics. Win score is calculated as
$$
ws = \text{points} + \text{total rebounds} + \text{steals} + \frac{1}{2}(\text{blocked shots} + \text{assists}) - \text{field goal attempts} \\
- \text{turnovers} - \frac{1}{2}(\text{free throws} + \text{personal fouls}).
$$
As noted in [2], this equation rewards players for positive contributions and penalizes them for negative contributions. The problem with this metric is that the units aren't very interpretable. The actual number can be compared between players but as far as I can tell its tricky to find the dollar value of a player from this number or trace the quantity back to total wins of a team. The interesting thing about the top 20 players is that it does produce a different ranking compared to win share. Of course the equation above is only looking at a players individual statistics rather than accounting for other factors on the team. 
```{r}
#Calculate win score

player_data_clean$win_score = player_data_clean$PTS + player_data_clean$TRB + player_data_clean$STL + .5*(player_data_clean$BLK + player_data_clean$AST) - player_data_clean$FGA - player_data_clean$TOV - .5*(player_data_clean$FT + player_data_clean$PF)
cols <- c("Player", "win_score")
df <-  player_data_clean[order(-player_data_clean$win_score),cols] 
df <- df[1:20,]
df$Player <- lapply(df$Player, function(x) {sub("\\\\.*","",x)})


kable(x=df, align=c('l','c'), row.names = FALSE, col.names = c('Player', 'Win Score'), caption="\\label{wa_corr}Win Score Top 20")  %>%
      kable_styling(latex_options = c("striped","hold_position"),
                    full_width = FALSE,font_size = 12, bootstrap_options = c("striped", "hover"))

```

Win Score produces an interesting ranking compared to the other metrics outlined in the next sections. Rudy Gobert makes the No. 1 spot and James Harden is in 9th. This could yield an objective way to compare players based on season stats but it doesn't have the correct units to evaluate MRP. 

#Wins Produced

For Wins Produced I am following the formula outlined in The [Wages of Wins Journal](http://wagesofwins.com/how-to-calculate-wins-produced/ "The Wages of Wins Journal") article titled 'How to calculate Wins Produced'. This article outlines a complicated formula that involves using regression coefficients with variables that are similar to Win Score but then makes adjustments for defensive rebounds, assists, position, and league averages. The article also mentions that some of these adjustments don't end up making a large difference because of the robustness of the coefficients and league averages given the amount of data available. For simplicity I am excluding the adjustment due to position because I don't have data on the changing positions of each player. 


```{r}
#Step One:
player_data_tm <- join(player_data_clean, team_key, by = "Tm")
player_data_tm <- join(player_data_tm, opp_data, by = "Team")
player_data_tm <- join(player_data_tm, team_data, by = "Team")

player_data_tm$OppFTM <- player_data_tm$PF/player_data_tm$TPF*player_data_tm$OFT 



player_data_tm$PROD <- with(player_data_tm, X3P*0.064 + X2P*0.032 + FT*0.017 + (FGA-FG)*-0.034 + (FTA - FT)*-0.015 + ORB*0.034 + DRB*0.034 + TOV*-0.034 + STL*0.033 + OppFTM*-0.017 + BLK*0.020)
player_data_tm$P48 <- (player_data_tm$PROD/player_data_tm$MP)*48
```



```{r}
#Step two:
#1
player_data_tm$TDRBPM <- with(player_data_tm, (TDRB-DRB)/(TMP-MP))
#2
player_data_tm$DRBL <- player_data_tm$TDRBPM*(-0.504)
#3
player_data_tm$VDRB <- player_data_tm$DRBL*(0.034)*player_data_tm$MP  
#4
by_team1 <- aggregate(player_data_tm$VDRB, by=list(player_data_tm$Tm), FUN=sum)
colnames(by_team1) <- c("Tm", "Sum1")

player_data_tm <- join(player_data_tm, by_team1, by = "Tm")

#5
player_data_tm$VDRBI <- player_data_tm$Sum1*(player_data_tm$DRB/player_data_tm$TDRB)


player_data_tm$PROD_DREBADJ <- (((player_data_tm$Sum1 - player_data_tm$VDRBI) + player_data_tm$PROD)/player_data_tm$MP)*48

```





```{r}
#Step Three: Adjust for Assists
#1
TAPM <- with(player_data_tm, (TAST - AST)/(TMP-MP))
#2
TAPM2 <- TAPM*0.725 
#3
TAPM3 <- TAPM2*2
#4
TAPM4 <- TAPM3*player_data_tm$FGA
#5
player_data_tm$TAPM5 <- TAPM4*0.032586
by_team1 <- aggregate(player_data_tm$TAPM5, by=list(player_data_tm$Tm), FUN=sum)
colnames(by_team1) <- c("Tm", "ASTSum1")
#6
player_data_tm <- join(player_data_tm, by_team1, by = "Tm")
#fin
player_data_tm$AST_FIN <- player_data_tm$ASTSum1*(player_data_tm$AST/player_data_tm$TAST)
```




```{r}
#Step four: Incorporate team defense and calculate adjusted P48
player_data_tm$TDA <- with(player_data_tm, ((O3P*-0.064 + O2P*-0.031+OTOV*0.033+TTOV*-0.034+TRB*0.033-TBLK*-0.02)/TMP)*48)



player_data_tm$adjp48 <- player_data_tm$P48+ (mean(player_data_tm$TDA, by=list(player_data_tm$Tm), FUN=mean) - player_data_tm$TDA)

```





```{r}
#Skip to step 6
player_data_tm$relAdjP48 <- player_data_tm$adjp48 - mean(player_data_tm$adjp48, by=list(player_data_tm$Tm), FUN=mean)
player_data_tm$WP48 <- player_data_tm$relAdjP48 + 0.099


player_data_tm$WP <- round(player_data_tm$WP48/48*player_data_tm$MP, 4)
#sum(player_data_tm[which(player_data_tm$Tm == "UTA"),"WP"])
#player_data_tm[,c("Player", "WP")]


#create data frame of focused players. Output win share, win score, and wins produced. 
cols <- c("Player", "WP")
df <-  na.omit(player_data_tm[order(-player_data_tm$WP),cols])
df <- df[1:20,]
df$Player <- lapply(df$Player, function(x) {sub("\\\\.*","",x)})
cols <- c("Player", "WP")
kable(x=df[,cols], align=c('l','c'), row.names = FALSE, col.names = c('Player', 'WP'), caption="\\label{wa_corr}Wins Produced Top 20")  %>%
      kable_styling(latex_options = c("striped","hold_position"),
                    full_width = FALSE,font_size = 12, bootstrap_options = c("striped", "hover"))
```


The rankings show that these numbers are more interpretable than Win Score and even have a similar ranking and mix of players in the top spots. However, to say that a player like Rudy Gobert accounts for more than half of the total wins of the Jazz in 2018-19 seems like a long shot. This led me to look into Real Plus-Minus wins to see if I could get a more conservative number than the metrics so far. 


#RPM Wins

Originally developed by ESPN, RPM Wins or Real Plus-Minus Wins provides an estimate of the number of wins each player has contributed to his team's win total on the season. This metric takes into account the players Real Plus-Minus which is the point differential when the player is on/off the court and the number of possesions played. 


```{r}

cols <- c("Player", "WINS")
df <-  player_rpmw_data_raw[order(-player_rpmw_data_raw$WINS),cols] 
df <- df[1:20,]


kable(x=df[,cols], align=c('l','c'), row.names = FALSE, col.names = c('Player', 'RPM Wins'), caption="\\label{wa_corr}RPM Wins Top 20")  %>%
      kable_styling(latex_options = c("striped","hold_position"),
                    full_width = FALSE,font_size = 12, bootstrap_options = c("striped", "hover"))

```

```{r}
player_data_tm <- join(player_data_tm, team_cost_data, by="Tm")
player_data_tm <- join(player_data_tm, player_data_ws_clean, by="Player")
player_data_tm$MRP <-  player_data_tm$WP*player_data_tm$CPW
player_data_tm$MRP_WS <-  player_data_tm$WS*player_data_tm$CPW
player_agg <- aggregate(player_data_tm$MRP, by=list(player_data_tm$Player), FUN=sum)
colnames(player_agg) <- c('Player', 'MRP')
player_data_slry <- join(player_salary_data[,c('Player', 'X2018.19')], player_agg, by = "Player")


```





```{r}
player_data_tm <- join(player_data_tm, team_cost_data, by="Tm")
player_data_tm$MRP <-  player_data_tm$WS*player_data_tm$CPW
player_agg <- aggregate(player_data_tm$MRP, by=list(player_data_tm$Player), FUN=sum)
colnames(player_agg) <- c('Player', 'MRP')
player_data_slry <- join(player_salary_data[,c('Player', 'X2018.19')], player_agg, by = "Player")

```

The ranking shows a mix of different players compared to Win Share. For example Lebron James doesn't even make the top 20 for Win Share but has a reasonable number for RPM Wins. This ranking seems more realistic to me and the consensus accross analysts seems to indicate a bias more towards RPM Wins than Win Share. Of course the argument has been made in many articles that these advanced stats are somewhat meaningless given the fact that we are crediting wins on an individual basis rather than to the entire team. However, for the sake of this analysis I am going to ignore all this.


#Win Metric Comparison

One simple test to evaluate if this method works and which quantity of wins is more accurate/reasonable is to check if a player-for-player trade produces a near break-even value. The Utah Jazz recently traded Jae Crowder, Kyle Korver, and Grayson Allen to the Memphis Grizzlies for Mike Conley. This trade only makes sense for the Jazz if they expect Conley to replace the output of the other three based on his past performance and hopefully exceed that in the near future. We can simply compare the total MRP before and after the trade to not only compare which measure of wins gives us equal trade value but also show if the Jazz are getting a good deal. 

In each section below we calculate MRP for each player using the chosen metric for wins and compare that to the player salary. To calculate the value a player is producing we can simply take the difference between MRP and player salary to show if the player is worth what they are being paid. We will simply call this number 'Net Output Value' or 'NOV' for short.  If a player is producing more value than they are being paid NOV is positive otherwise the team is losing money on the player and NOV will come up negative. First we show what these values are before the trade for each player, then evaluate what the total value of the team is before and after the Conley trade. 

##Utah Jazz Win Share NOV



```{r}
#Add column for surplus ws, surplus wp
player_data_tm$Player <- unlist(lapply(player_data_tm$Player, function(x) {sub("\\,.*","",x)}))
player_data_slry <- join(player_salary_data[,c('Player', 'X2018.19', 'Tm')], player_data_tm, by = "Player")
player_data_slry$Player <- unlist(lapply(player_data_slry$Player, function(x) {sub("\\\\.*","",x)}))
player_data_slry <- join(player_data_slry, player_rpmw_data_raw, by = "Player")

player_data_slry$MRP <-  player_data_slry$WS*player_data_slry$CPW
player_data_jzz <- player_data_slry[which(player_data_slry$Tm == 'UTA'),]

cols <- c("Player", "MRP", "X2018.19")
df <-  player_data_jzz[order(-player_data_jzz$MRP),cols]
df$Player <- lapply(df$Player, function(x) {sub("\\\\.*","",x)})
df$MRP <- dollar(df$MRP)
df$Salary <- lapply(df$X2018.19, function(x) {sub("\\$","",x)})
df$Salary <- as.numeric(df$Salary)
df$Salary <- dollar(df$Salary)
df$diff1 <- as.numeric(gsub('[$,]', '', df$MRP)) - as.numeric(gsub('[$,]', '', df$Salary))
cols <- c("Player", "MRP", "Salary", "diff1")
df <-  df[order(-df$diff1),cols]
df$diff2 <- dollar(df$diff1)
cols <- c("Player", "MRP", "Salary", "diff2")
kable(x=df[,cols], align=c('l','c'), row.names = FALSE, col.names = c('Player', 'MRP', 'Salary', "NOV"), caption="\\label{wa_corr}Utah Jazz End Of Season 2019")  %>%
      kable_styling(latex_options = c("striped","hold_position"),
                    full_width = TRUE,font_size = 12, bootstrap_options = c("striped", "hover"))
#sum(player_data_tm[which(player_data_tm$Tm == "CLE"),"WS"])
wo <- sum(df$diff1)-df[which(df$Player == "Kyle Korver"), 'diff1']+ df[which(df$Player == "Grayson Allen"), 'diff1'] + df[which(df$Player == "Jae Crowder"), 'diff1']
```

Before the Trade the total NOV of the Utah Jazz players is `r dollar(sum(df$diff1))`. If we remove Crowder, Korver, and Allen the Jazz total NOV becomes `r dollar(wo)`. 
```{r}
player_data_slry <- join(player_salary_data, player_data_tm, by = "Player")
player_data_co <- player_data_slry[which(player_data_slry$Player == 'Mike Conley\\conlemi01'),]
player_data_co$after <-  player_data_co$WS*player_data_co[1,'CPW']

cols <- c("Player", "MRP", "X2018.19", "after")
df <-  player_data_co[,cols]
df$Player <- lapply(df$Player, function(x) {sub("\\\\.*","",x)})
df$MRP <- dollar(df$MRP)
df$Salary <- lapply(df$X2018.19, function(x) {sub("\\$","",x)})
df$Salary <- as.numeric(df$Salary)
df$Salary <- dollar(df$Salary)
df$diff1 <- as.numeric(gsub('[$,]', '', df$after)) - as.numeric(gsub('[$,]', '', df$Salary))
cols <- c("Player", "MRP", "Salary", "diff1")
df <-  df[order(-df$diff1),cols]
df$diff2 <- dollar(df$diff1)
cols <- c("Player", "MRP", "Salary", "diff2")
kable(x=df[,cols], align=c('l','c'), row.names = FALSE, col.names = c('Player', 'MRP', 'Salary', "NOV" ), caption="")  %>%
      kable_styling(latex_options = c("striped","hold_position"),
                    full_width = TRUE,font_size = 12, bootstrap_options = c("striped", "hover"))


w <- wo+df$diff1
```

When we add back Conley's production to the Jazz we get `r dollar(w)`. Win Share shows that the Jazz lost money on the current output of Conley but not by much. But keep in mind this is relative to the performance of Mephis last season which was only 33 wins. This is still near break even especially because the Jazz [expect](https://www.deseretnews.com/article/900075833/what-would-a-mike-conley-trade-mean-for-the-utah-jazz-moving-forward.html "What the trade means for Jazz") Conley to continue to improve and be a central contributor to team performance. 

##Utah Jazz Wins Produced NOV

```{r}
#Add column for surplus ws, surplus wp
player_data_tm$Player <- unlist(lapply(player_data_tm$Player, function(x) {sub("\\,.*","",x)}))
player_data_slry <- join(player_salary_data[,c('Player', 'X2018.19', 'Tm')], player_data_tm, by = "Player")
player_data_slry$Player <- unlist(lapply(player_data_slry$Player, function(x) {sub("\\\\.*","",x)}))
player_data_slry <- join(player_data_slry, player_rpmw_data_raw, by = "Player")

player_data_slry$MRP <-  player_data_slry$WP*player_data_slry$CPW
player_data_jzz <- player_data_slry[which(player_data_slry$Tm == 'UTA'),]

cols <- c("Player", "MRP", "X2018.19")
df <-  player_data_jzz[order(-player_data_jzz$MRP),cols]
df$Player <- lapply(df$Player, function(x) {sub("\\\\.*","",x)})
df$MRP <- dollar(df$MRP)
df$Salary <- lapply(df$X2018.19, function(x) {sub("\\$","",x)})
df$Salary <- as.numeric(df$Salary)
df$Salary <- dollar(df$Salary)
df$diff1 <- as.numeric(gsub('[$,]', '', df$MRP)) - as.numeric(gsub('[$,]', '', df$Salary))
cols <- c("Player", "MRP", "Salary", "diff1")
df <-  df[order(-df$diff1),cols]
df$diff2 <- dollar(df$diff1)
cols <- c("Player", "MRP", "Salary", "diff2")
kable(x=df[,cols], align=c('l','c'), row.names = FALSE, col.names = c('Player', 'MRP', 'Salary', "NOV"), caption="\\label{wa_corr}Utah Jazz Player NOV WP")  %>%
      kable_styling(latex_options = c("striped","hold_position"),
                    full_width = TRUE,font_size = 12, bootstrap_options = c("striped", "hover"))
#sum(player_data_tm[which(player_data_tm$Tm == "CLE"),"WS"])
wo <- sum(df$diff1)-df[which(df$Player == "Kyle Korver"), 'diff1']+ df[which(df$Player == "Grayson Allen"), 'diff1'] + df[which(df$Player == "Jae Crowder"), 'diff1']
```

Before the Trade the MRP of the players is `r dollar(sum(df$diff1))`. If we remove Korver, Allen, and Crowder the Jazz total value of MRP becomes `r dollar(wo)`. 
```{r}
player_data_slry <- join(player_salary_data, player_data_tm, by = "Player")
player_data_co <- player_data_slry[which(player_data_slry$Player == 'Mike Conley\\conlemi01'),]
player_data_co$after <-  player_data_co$WP*player_data_co$CPW

cols <- c("Player", "MRP", "X2018.19", "after")
df <-  player_data_co[,cols]
df$Player <- lapply(df$Player, function(x) {sub("\\\\.*","",x)})
df$MRP <- dollar(df$after)
df$Salary <- lapply(df$X2018.19, function(x) {sub("\\$","",x)})
df$Salary <- as.numeric(df$Salary)
df$Salary <- dollar(df$Salary)
df$diff1 <- as.numeric(gsub('[$,]', '', df$after)) - as.numeric(gsub('[$,]', '', df$Salary))
cols <- c("Player", "MRP", "Salary", "diff1")
df <-  df[order(-df$diff1),cols]
df$diff2 <- dollar(df$diff1)
cols <- c("Player", "MRP", "Salary", "diff2")
kable(x=df[,cols], align=c('l','c'), row.names = FALSE, col.names = c('Player', 'MRP', 'Salary', "NOV" ), caption="")  %>%
      kable_styling(latex_options = c("striped","hold_position"),
                    full_width = TRUE,font_size = 12, bootstrap_options = c("striped", "hover"))


w <- wo+df$diff1
```

When we add back Conley's production to the Jazz we get `r dollar(w)`. Wins Produced is showing that the Jazz are lost almost 28 million on this trade. I'm skeptical of this because this is drasitically underestimating Conley's output relative to his salary. It seems unreasonable that the Jazz would lose 28 million from a trade. 

##Utah Jazz RPM Wins NOV

```{r}
#Add column for surplus ws, surplus wp
player_data_tm$Player <- unlist(lapply(player_data_tm$Player, function(x) {sub("\\,.*","",x)}))
player_data_slry <- join(player_salary_data[,c('Player', 'X2018.19', 'Tm')], player_data_tm, by = "Player")
player_data_slry$Player <- unlist(lapply(player_data_slry$Player, function(x) {sub("\\\\.*","",x)}))
player_data_slry <- join(player_data_slry, player_rpmw_data_raw, by = "Player")

player_data_slry$MRP <-  player_data_slry$WINS*player_data_slry$CPW
player_data_jzz <- player_data_slry[which(player_data_slry$Tm == 'UTA'),]

cols <- c("Player", "MRP", "X2018.19", "MRP")
df <-  player_data_jzz[order(-player_data_jzz$MRP),cols]
df$Player <- lapply(df$Player, function(x) {sub("\\\\.*","",x)})
df$MRP <- dollar(df$MRP)
df$Salary <- lapply(df$X2018.19, function(x) {sub("\\$","",x)})
df$Salary <- as.numeric(df$Salary)
df$Salary <- dollar(df$Salary)
df$diff1 <- as.numeric(gsub('[$,]', '', df$MRP)) - as.numeric(gsub('[$,]', '', df$Salary))
cols <- c("Player", "MRP", "Salary", "diff1")
df <-  df[order(-df$diff1),cols]
df$diff2 <- dollar(df$diff1)
cols <- c("Player", "MRP", "Salary", "diff2")
kable(x=df[,cols], align=c('l','c'), row.names = FALSE, col.names = c('Player', 'MRP', 'Salary', "NOV"), caption="Utah Jazz Player NOV RPM")  %>%
      kable_styling(latex_options = c("striped","hold_position"),
                    full_width = TRUE,font_size = 12, bootstrap_options = c("striped", "hover"))
#sum(player_data_tm[which(player_data_tm$Tm == "CLE"),"WS"])
wo <- sum(df$diff1)-df[which(df$Player == "Kyle Korver"), 'diff1']+ df[which(df$Player == "Grayson Allen"), 'diff1'] + df[which(df$Player == "Jae Crowder"), 'diff1']
```

Before the Trade the MRP of the players is `r dollar(sum(df$diff1))`. If we remove Korver, Allen, and Crowder the Jazz total value of MRP becomes `r dollar(wo)`. 
```{r}
player_data_co <- player_data_slry[which(player_data_slry$Player == 'Mike Conley'),]
player_data_co$after <-  player_data_co$WINS*player_data_co[1,'CPW']

cols <- c("Player", "MRP", "X2018.19", "after")
df <-  player_data_co[,cols]
df$Player <- lapply(df$Player, function(x) {sub("\\\\.*","",x)})
df$MRP <- dollar(df$MRP)
df$Salary <- lapply(df$X2018.19, function(x) {sub("\\$","",x)})
df$Salary <- as.numeric(df$Salary)
df$Salary <- dollar(df$Salary)
df$diff1 <- as.numeric(gsub('[$,]', '', df$after)) - as.numeric(gsub('[$,]', '', df$Salary))
cols <- c("Player", "MRP", "Salary", "diff1")
df <-  df[order(-df$diff1),cols]
df$diff2 <- dollar(df$diff1)
cols <- c("Player", "MRP", "Salary", "diff2")
kable(x=df[,cols], align=c('l','c'), row.names = FALSE, col.names = c('Player', 'MRP', 'Salary', "NOV" ), caption="")  %>%
      kable_styling(latex_options = c("striped","hold_position"),
                    full_width = TRUE,font_size = 12, bootstrap_options = c("striped", "hover"))


w <- wo+df$diff1
```

When we add back Conley's production to the Jazz we get the total value of productivity less salary to be `r dollar(w)`. Using RPM Wins gets the closest value to break even for this trade of the three other methods. This is a good indication that RPM Wins might be the best of the others to incorporate into the calculation of MRP. 

#Utah Jazz New Roster NOV

To further evaluate this what the results of using MRP together with RPM Wins to get player value we can also look at the recent acquisitions and trades the Jazz have made. The Jazz added Bojan Bogdanovic, Ed Davis, Jeff Green, and Emmanuel Mudiay. The Jazz also traded Derrick Favors for some draft picks. I am ignoring the new acquisitions during the draft because I don't have the necessary data. The table below shows the new roster ordered by NOV. 

```{r}
#Add column for surplus ws, surplus wp
player_data_tm$Player <- unlist(lapply(player_data_tm$Player, function(x) {sub("\\,.*","",x)}))
player_data_slry <- join(player_salary_data[,c('Player', 'X2018.19', 'Tm')], player_data_tm, by = "Player")
player_data_slry$Player <- unlist(lapply(player_data_slry$Player, function(x) {sub("\\\\.*","",x)}))
player_data_slry <- join(player_data_slry, player_rpmw_data_raw, by = "Player")

player_data_slry$MRP <-  player_data_slry$WINS*player_data_slry$CPW
player_data_jzz <- player_data_slry[which(player_data_slry$Tm == 'UTA'),]

player_data_n1 <- player_data_slry[which(player_data_slry$Player == 'Bojan Bogdanovic'),]
player_data_n2 <- player_data_slry[which(player_data_slry$Player == 'Ed Davis'),]
player_data_n3 <- player_data_slry[which(player_data_slry$Player == 'Mike Conley'),]
player_data_n4 <- player_data_slry[which(player_data_slry$Player == 'Jeff Green'),]
player_data_n5 <- player_data_slry[which(player_data_slry$Player == 'Emmanuel Mudiay'),]
player_data_jzz <- player_data_jzz[which(player_data_jzz$Player != "Kyle Korver" & player_data_jzz$Player != "Grayson Allen" & player_data_jzz$Player != "Jae Crowder"& player_data_jzz$Player != "Derrick Favors"),]

player_data_jzz <- rbind(player_data_jzz,player_data_n1,player_data_n2,player_data_n3, player_data_n4, player_data_n5)
cols <- c("Player", "MRP", "X2018.19", "MRP")
df <-  player_data_jzz[order(-player_data_jzz$MRP),cols]
df$Player <- lapply(df$Player, function(x) {sub("\\\\.*","",x)})
produce <- sum(df$MRP)
df$MRP <- dollar(df$MRP)
df$Salary <- lapply(df$X2018.19, function(x) {sub("\\$","",x)})
df$Salary <- as.numeric(df$Salary)
cost <- sum(df$Salary)
df$Salary <- dollar(df$Salary)
df$diff1 <- as.numeric(gsub('[$,]', '', df$MRP)) - as.numeric(gsub('[$,]', '', df$Salary))
cols <- c("Player", "MRP", "Salary", "diff1")
df <-  df[order(-df$diff1),cols]
df$diff2 <- dollar(df$diff1)
cols <- c("Player", "MRP", "Salary", "diff2")
kable(x=df[,cols], align=c('l','c'), row.names = FALSE, col.names = c('Player', 'MRP', 'Salary', "NOV"), caption="\\label{wa_corr}Utah Jazz Player NOV WS")  %>%
      kable_styling(latex_options = c("striped","hold_position"),
                    full_width = TRUE,font_size = 12, bootstrap_options = c("striped", "hover"))
#sum(player_data_tm[which(player_data_tm$Tm == "CLE"),"WS"])
wo <- sum(df$diff1)

profit <- produce - cost

```

When we add Conley, Davis, Bogdanovic, Green, and Mudiay we get an NOV of `r dollar(wo)`. This would indicate that the Jazz would be much more productive next season with these new players supposedly producing almost 20 million more value compared to the end of regular season. You can also see in the ranking of NOV that the top five almost line up with the starting five for next season with the exception of Mike Conley who I believe is under valued and will rise in the rankings throughout his first season with the Jazz as he gets more opportunity to play and as the Jazz win games. 


#NBA Player NOV

Now that we have a realistic way to compare player values we can apply it to the rest of the NBA. Below I show the players with the highest value of output (MRP) as well as the highest and lowest NOV which correspond to being the most over/under valued players. 


```{r}
cols <- c("Player", "MRP", "X2018.19")
df <-  na.omit(player_data_slry[order(-player_data_slry$MRP),cols])
df2 <-  na.omit(player_data_slry[order(-player_data_slry$MRP),cols])
df <- df[1:20,]
df$Player <- lapply(df$Player, function(x) {sub("\\\\.*","",x)})
df$MRP <- dollar(df$MRP)
df$Salary <- lapply(df$X2018.19, function(x) {sub("\\$","",x)})
df$Salary <- as.numeric(df$Salary)
df$Salary <- dollar(df$Salary)
df$diff <- dollar(as.numeric(gsub('[$,]', '', df$MRP)) - as.numeric(gsub('[$,]', '', df$Salary)))



df2 <- df2[1:20,]
df2$Player <- lapply(df2$Player, function(x) {sub("\\\\.*","",x)})
df2$MRP_D <- dollar(df2$MRP)
df2$Salary <- lapply(df2$X2018.19, function(x) {sub("\\$","",x)})
df2$Salary <- as.numeric(df2$Salary)
df2$Salary <- dollar(df2$Salary)
df2$diff <- dollar(as.numeric(gsub('[$,]', '', df2$MRP)) - as.numeric(gsub('[$,]', '', df2$Salary)))
cols <- c("Player", "MRP_D", "Salary", "diff")
kable(x=df2[,cols], align=c('l','c'), row.names = FALSE, col.names = c('Player', 'MRP', 'Salary', "NOV"), caption="\\label{wa_corr}MRP Top 20")  %>%
      kable_styling(latex_options = c("striped","hold_position"),
                    full_width = TRUE,font_size = 12, bootstrap_options = c("striped", "hover"))

```

```{r}


cols <- c("Player", "MRP", "X2018.19")
df <-  na.omit(player_data_slry[order(player_data_slry$MRP),cols])
df <- df[1:20,]
df$Player <- lapply(df$Player, function(x) {sub("\\\\.*","",x)})
df$MRP <- dollar(df$MRP)
df$Salary <- lapply(df$X2018.19, function(x) {sub("\\$","",x)})
df$Salary <- as.numeric(df$Salary)
df$Salary <- dollar(df$Salary)
df$diff <- dollar(abs(as.numeric(gsub('[$,]', '', df$MRP))) - abs(as.numeric(gsub('[$,]', '', df$Salary))))
cols <- c("Player", "MRP", "Salary", "diff")
kable(x=df[,cols], align=c('l','c'), row.names = FALSE, col.names = c('Player', 'MRP', 'Salary', "NOV"), caption="\\label{wa_corr}MRP Bottom 20")  %>%
      kable_styling(latex_options = c("striped","hold_position"),
                    full_width = FALSE,font_size = 12, bootstrap_options = c("striped", "hover"))

```

```{r}
df$diff <- as.numeric(gsub('[$,]', '', df$MRP)) - as.numeric(gsub('[$,]', '', df$Salary))
cols <- c("Player", "MRP", "Salary", "diff")
df <- df[order(-df$diff),cols]
df$diff <- dollar(df$diff)
cols <- c("Player", "MRP", "Salary", "diff")
kable(x=df[,cols], align=c('l','c'), row.names = FALSE, col.names = c('Player', 'MRP', 'Salary', "NOV"), caption="\\label{wa_corr}Most Undervalued Players")  %>%
      kable_styling(latex_options = c("striped","hold_position"),
                    full_width = FALSE,font_size = 12, bootstrap_options = c("striped", "hover"))

```

```{r}
cols <- c("Player", "MRP", "X2018.19")
df <-  na.omit(player_data_slry[order(-player_data_slry$MRP),cols])
df$Player <- lapply(df$Player, function(x) {sub("\\\\.*","",x)})
df$MRP <- dollar(df$MRP)
df$Salary <- lapply(df$X2018.19, function(x) {sub("\\$","",x)})
df$Salary <- as.numeric(df$Salary)
df$Salary <- dollar(df$Salary)
df$diff <- dollar(as.numeric(gsub('[$,]', '', df$MRP)) - as.numeric(gsub('[$,]', '', df$Salary)))
df$diff <- as.numeric(gsub('[$,]', '', df$MRP)) - as.numeric(gsub('[$,]', '', df$Salary))
cols <- c("Player", "MRP", "Salary", "diff")
df <- df[order(df$diff),cols]
df$diff <- dollar(df$diff)
cols <- c("Player", "MRP", "Salary", "diff")
kable(x=df[1:20,cols], align=c('l','c'), row.names = FALSE, col.names = c('Player', 'MRP', 'Salary', "NOV"), caption="\\label{wa_corr}Most Overvalued Players")  %>%
      kable_styling(latex_options = c("striped","hold_position"),
                    full_width = FALSE,font_size = 12, bootstrap_options = c("striped", "hover"))

```



Keep in mind that these MRP numbers correspond to a given player on a given team. If the team isn't winning very much, its hard for a star player to have a high MRP because Win Share and RPM Wins will be lower for all players on that team. Thus a star player could appear over-valued, but only when playing for that team. The numbers could change drasitically if they move to a more productive team. 

Overall using MRP with RPM Wins to get Net Output Value is simple and it seems to work well given the examples with the Jazz and the recent trades and acquisitions. I also found that Win Share can be used in place of RPM Wins but it seems to overestimate what both of these metrics are trying to quantify. I also found that Win Score and Wins Produced aren't realistic for calculating MRP. But it is important to remember that these quantities are heavily debated and there is no silver bullet to measuring the value of player output to a team. I look forward to evaluating this again after next season to see what has changed and if there are any insights by comparing results. I also want to explore comparing the MRP of each team, although it is hard to compare team to team by dollar amounts rather than win-loss record and regular season stats. There are a lot of ideas that came out of this analysis and I look forward to more reasearch. Go Jazz!





#Sources

[1] The Wages of Wins Journal. (2011). How to calculate Wins Produced. Retrieved from http://wagesofwins.com/how-to-calculate-wins-produced/

[2] Berri, D. (2006, June 16). Simple Models of Player Performance. Retrieved from https://dberri.wordpress.com/2006/05/21/simple-models-of-player-performance/

[3] 2018-19 NBA Player Stats: Advanced. (n.d.). Retrieved from https://www.basketball-reference.com/leagues/NBA_2019_advanced.html

[4] Wins Produced vs. Win Score. (2006, May 25). Retrieved from https://dberri.wordpress.com/2006/05/26/wins-produced-vs-win-score/

[5] Dubin, J. (2019, April 16). Which NBA Player Literally Gives His Team The Most Value? Retrieved from https://fivethirtyeight.com/features/forget-giannis-pascal-siakam-is-our-mvp/

[6] NBA Real Plus-Minus - National Basketball Association - ESPN. (2019, June 19). Retrieved from http://www.espn.com/nba/statistics/rpm

[7] Leeds, M., & Allmen, P. V. (2016). The Economics of Sports. London, England: Routledge.

[8] McDonald, R. (2019, June 18). What would a Mike Conley trade mean for the Utah Jazz moving forward? Retrieved from https://www.deseretnews.com/article/900075833/what-would-a-mike-conley-trade-mean-for-the-utah-jazz-moving-forward.html

[9] Understanding Marginal Revenue Products (MRPs). (2011, July 18). Retrieved from https://www.investopedia.com/terms/m/marginal-revenue-product-mrp.asp